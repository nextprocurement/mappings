###################################################################################################
# RML mapping rules for OCDS 1.0 (https://standard.open-contracting.org/1.0/en/release-schema.json)
# 
# Author   : María Navas-Loro
# License  : Apache License 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
# Project  : Developed as part of the nextProcurement project (http://nextprocurement-project.com/)
# Funding  : TheyBuyForYou has received funding from the European Union's Horizon 2020
#            research and innovation programme under grant agreement No 
###################################################################################################


# RML prefixes
@prefix rr:       <http://www.w3.org/ns/r2rml#> .
@prefix rml:      <http://semweb.mmlab.be/ns/rml#> .
@prefix ql:       <http://semweb.mmlab.be/ns/ql#> .

# Own prefixes
@base             <http://data.tbfy.eu/> .
@prefix tbfy:     <http://data.tbfy.eu/ontology/tbfy#> . 
@prefix ocds:     <http://data.tbfy.eu/ontology/ocds#> .

# External prefixes
@prefix dc:       <http://purl.org/dc/terms/> .
@prefix foaf:     <http://xmlns.com/foaf/0.1/> .
@prefix owl:      <http://www.w3.org/2002/07/owl#> .
@prefix rdf:      <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix schema:   <http://schema.org/> .
@prefix skos:     <http://www.w3.org/2004/02/skos/core#> .
@prefix xsd:      <http://www.w3.org/2001/XMLSchema#> .
@prefix schema:   <http://schema.org/> .




# *********************************
# Contracting Process mapping rules
# *********************************

<ContractingProcessMap>
  a rr:TriplesMap ;
  
  rml:logicalSource [
    rr:sqlVersion rr:SQL2008;
    rml:query """
        SELECT "Número de Expediente"
		FROM 'C:/Users/mnavas/CODE/NextProcurement/newMorphKGC/data/outsiders_2021.parquet'
    """;
    rml:referenceFormulation ql:Parquet
  ];
  
  
  rr:subjectMap [
    rr:template "http://data.nextprocurement.linkeddata.es/contractingProcess/{Número de Expediente}" ;
    rr:class ocds:contractingProcess
  ];
  
  rr:predicateObjectMap [
    rr:predicate ocds:hasTender ;
    rr:objectMap [
      rr:template "http://data.nextprocurement.linkeddata.es/contractingProcess/{Número de Expediente}/tender/{Número de Expediente}" ;
    ]
  ].

<LotMap>
  a rr:TriplesMap ;

  rml:logicalSource [
    rr:sqlVersion rr:SQL2008;
    rml:query """
        SELECT "Número de Expediente", 
		CASE WHEN length(replace("Lote",'[\\s\\[\\]]+',''))=0 THEN 0 
		ELSE UNNEST(string_split(replace("Lote",'[\\s]+','')[2:-1], ','))
		END AS Lotes,
		CASE WHEN length(replace("Número de Licitadores Participantes",'[\\s\\[\\]]+',''))=0 THEN 0 
		ELSE UNNEST(CAST(CAST(string_split(replace(replace("Número de Licitadores Participantes",'[\\s]+',''), 'NULL', '0')[2:-1], ',') AS DOUBLE[]) AS INT[]))
		END AS NumTenders
		FROM 'C:/Users/mnavas/CODE/NextProcurement/newMorphKGC/data/outsiders_2021.parquet'
    """;
    rml:referenceFormulation ql:Parquet
  ];
  
  
  rr:subjectMap [
    rr:template "http://data.nextprocurement.linkeddata.es/contractingProcess/{Número de Expediente}/lot/{Lotes}" ;
    rr:class ocds:Lot
  ];

  rr:predicateObjectMap [
    rr:predicate ocds:numberOfTenderers ;
    rr:objectMap [
      rml:reference "NumTenders" ;
      rr:datatype xsd:integer
    ]
  ].
  
   
<TenderMap>
  a rr:TriplesMap ;

  rml:logicalSource [
    rr:sqlVersion rr:SQL2008;
    rml:query """
        SELECT "Número de Expediente", "title", "Objeto del Contrato", "Estado", "ID",
		CASE "Tipo de Contrato" WHEN 1 THEN 'goods' 
             WHEN 2 THEN 'services' 
             WHEN 3 THEN 'works' 
             WHEN 31 THEN 'works' 
             WHEN 21 THEN 'services'
             ELSE 'other' 
             END as TipoContrato
		FROM 'C:/Users/mnavas/CODE/NextProcurement/newMorphKGC/data/outsiders_2021.parquet'
    """;
    rml:referenceFormulation ql:Parquet
  ];

  rr:subjectMap [
    rr:template "http://data.nextprocurement.linkeddata.es/contractingProcess/{Número de Expediente}/tender/{Número de Expediente}" ;
    rr:class ocds:Tender
  ];
      
  rr:predicateObjectMap [
    rr:predicate ocds:tenderId ;
    rr:objectMap [
      rml:reference "Número de Expediente" ;
      rr:datatype xsd:string
    ]
  ];

  rr:predicateObjectMap [
    rr:predicate dc:title ;
    rr:objectMap [ 
      rml:reference "title" ;
      rr:datatype xsd:string
    ]
  ];

  rr:predicateObjectMap [
    rr:predicate dc:description ;
    rr:objectMap [ 
      rml:reference "Objeto del Contrato" ;
      rr:datatype xsd:string
    ]
  ];

  rr:predicateObjectMap [
    rr:predicate ocds:tenderStatus ;
    rr:objectMap [
      rml:reference "Estado" ;
      rr:datatype xsd:string
    ]
  ];

  rr:predicateObjectMap [
    rr:predicate ocds:hasMinEstimatedValue ;
    rr:objectMap [
      rr:template "http://data.nextprocurement.linkeddata.es/contractingProcess/{Número de Expediente}/tender/{Número de Expediente}/minValue"
    ]
  ];

 rr:predicateObjectMap [
    rr:predicate ocds:hasMaxEstimatedValue ;
    rr:objectMap [
      rr:template "http://data.nextprocurement.linkeddata.es/contractingProcess/{Número de Expediente}/tender/{Número de Expediente}/maxValue"
    ]
  ];
 
  rr:predicateObjectMap [
    rr:predicate ocds:mainProcurementCategory ;
    rr:objectMap [
      rml:reference "TipoContrato" ;
      rr:datatype xsd:string
    ]
  ];

  

  rr:predicateObjectMap [
    rr:predicate ocds:hasContractPeriod ;
    rr:objectMap [
      rr:template "http://data.nextprocurement.linkeddata.es/contractingProcess/{Número de Expediente}/tender/{Número de Expediente}/contractPeriod"
    ]
  ];
  
  
  rr:predicateObjectMap [
    rr:predicate ocds:hasTenderPeriod ;
    rr:objectMap [
      rr:template "http://data.nextprocurement.linkeddata.es/contractingProcess/{Número de Expediente}/tender/{Número de Expediente}/tenderPeriod"
    ]
  ];

  rr:predicateObjectMap [
    rr:predicate ocds:hasDocument ;
    rr:objectMap [
      rr:template "http://data.nextprocurement.linkeddata.es/contractingProcess/{Número de Expediente}/tender/{Número de Expediente}/document/technicalSpecifications"
    ]
  ];
  
  rr:predicateObjectMap [
    rr:predicate ocds:hasDocument ;
    rr:objectMap [
      rr:template "http://data.nextprocurement.linkeddata.es/contractingProcess/{Número de Expediente}/tender/{Número de Expediente}/document/evaluationCriteria"
    ]
  ];
  
  rr:predicateObjectMap [
    rr:predicate ocds:isProcuringEntityFor ;
    rr:objectMap [
      rr:template "http://data.nextprocurement.linkeddata.es/contractingProcess/Organization/{ID}" ;
    ]
  ];    
  
  rr:predicateObjectMap [
    rr:predicate ocds:hasAward ;
    rr:objectMap [
      rr:template "http://data.nextprocurement.linkeddata.es/contractingProcess/{Número de Expediente}/tender/{Número de Expediente}/award"
    ]
  ].
